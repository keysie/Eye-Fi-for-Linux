#!/bin/bash

DSTPATH=/usr/local/eyefiserver
PYTHONPATH=/usr/bin
RCDPATH=/usr/local/eyefiserver/rc.d

if [ "$(whoami)" != "root" ]
then
	echo 
	echo "Error! Must run as root!"
	echo
	exit 0
fi

echo -n "Checking if socket is unused... "

result="$(sudo netstat -pln | grep 59278)"
len=${#result}

if [ ${len} != 0 ]
then
	echo "error"
else
	echo "ok"
fi

while [ ${len} != 0 ]
do
	echo -n "- Trying to kill process..."
	pid="$(echo ${result} | grep -P -o '(?<=(LISTEN ))[0-9]*(?=(/python))')"   
 	echo ${pid}
	sudo kill -6 ${pid}
	sleep 1

	result="$(sudo netstat -pln | grep 59278)"
	len=${#result}

	if [ ${len} != 0 ]
	then
		echo "- Process still running"
	else
		echo "- Sucessfully terminated"
	fi
done

echo 

if [ "$1" == "-v" ]
then
	echo "Starting Eye-Fi Server verbosely"
	${PYTHONPATH}/python ${DSTPATH}/bin/eyefiserver.py ${DSTPATH}/etc/eyefiserver.conf ${DSTPATH}/var/eyefiserver.log
else

	echo -n "Run server in foreground verbosely? [Y/n]:"
	read verb

	if [ "${verb}" == "" ] || [ "${verb}" == "y" ] || [ "${verb}" == "Y" ]
	then
		echo "Starting Eye-Fi Server verbosely"
		${PYTHONPATH}/python ${DSTPATH}/bin/eyefiserver.py ${DSTPATH}/etc/eyefiserver.conf ${DSTPATH}/var/eyefiserver.log
	else
		echo "Starting Eye-Fi Server in background"
		${RCDPATH}/S99EyeFiServer.sh start &
	fi
fi

